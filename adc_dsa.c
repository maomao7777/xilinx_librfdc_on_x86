#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <errno.h>
#include <time.h>
#include <sys/time.h>
#include <sys/types.h>
#include <sys/ioctl.h>
#include "xrfdc.h"


// /////////////////////////////////////////////////////////////////////////////
//    Macro declarations
// /////////////////////////////////////////////////////////////////////////////

#define RFDC_DEVICE_ID 0


// /////////////////////////////////////////////////////////////////////////////
//    Type declarations
// /////////////////////////////////////////////////////////////////////////////


// /////////////////////////////////////////////////////////////////////////////
//    Variables declarations
// /////////////////////////////////////////////////////////////////////////////

XRFdc RFdcInst;  /* RFdc driver instance */
XRFdc_Config Config;
struct metal_device *g_device;


// /////////////////////////////////////////////////////////////////////////////
//    Functions
// /////////////////////////////////////////////////////////////////////////////
/****************************
usp_rf_data_converter_0: usp_rf_data_converter@b0040000 {
    clock-names = "s_axi_aclk", "m0_axis_aclk", "s0_axis_aclk", "s1_axis_aclk";
    clocks = <&misc_clk_0>, <&misc_clk_2>, <&misc_clk_2>, <&misc_clk_2>;
    compatible = "xlnx,usp-rf-data-converter-2.4";
    num-insts = <0x1>;
    param-list = [ 00 00 00 00 00 00 04 b0 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 01 00 00 00 01 00 00 00 02 00 00 00 01 00 00 00 01 00 00 00 01 00 00 00 69 1d 55 4d 10 75 0f 40 b8 1e 85 eb 51 b8 6e 40 b8 1e 85 eb 51 b8 5e 40 20 00 00 00 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 1c 40 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 01 00 00 00 01 00 00 00 69 1d 55 4d 10 75 0f 40 b8 1e 85 eb 51 b8 6e 40 b8 1e 85 eb 51 b8 5e 40 20 00 00 00 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 1c 40 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 9a 99 99 99 99 99 19 40 00 00 00 00 00 00 b9 40 00 00 00 00 00 00 00 00 0a 00 00 00 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 24 40 02 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 9a 99 99 99 99 99 19 40 00 00 00 00 00 00 b9 40 00 00 00 00 00 00 00 00 0a 00 00 00 02 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 24 40 02 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 10 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 01 00 00 00 01 00 00 00 69 1d 55 4d 10 75 0f 40 b8 1e 85 eb 51 b8 6e 40 b8 1e 85 eb 51 b8 5e 40 30 00 00 00 03 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 14 40 02 00 00 00 01 00 00 00 00 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 01 00 00 00 04 00 00 00 08 00 00 00 00 00 00 00 02 00 00 00 01 00 00 00 04 00 00 00 08 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 00 00 00 40 9f 40 00 00 00 00 00 00 00 00 0a 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 14 40 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 00 00 00 40 9f 40 00 00 00 00 00 00 00 00 0a 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 14 40 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 40 00 00 00 00 00 40 9f 40 00 00 00 00 00 00 00 00 0a 00 00 00 01 00 00 00 01 00 00 00 00 00 00 00 00 00 00 00 00 00 14 40 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00 00 00 00 00 08 00 00 00 00 00 00 00 00 00 00 00 03 00 00 00];
    reg = <0x0 0xb0040000 0x0 0x40000>;
};
******************************/
uint8_t rfdc_init_pra[]=
{
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0xb0, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x69, 0x1d, 0x55, 0x4d, 0x10, 0x75, 0x0f, 0x40, 0xb8, 0x1e, 0x85, 0xeb, 0x51, 0xb8, 0x6e, 0x40,
0xb8, 0x1e, 0x85, 0xeb, 0x51, 0xb8, 0x5e, 0x40, 0x20, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x40,
0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x69, 0x1d, 0x55, 0x4d,
0x10, 0x75, 0x0f, 0x40, 0xb8, 0x1e, 0x85, 0xeb, 0x51, 0xb8, 0x6e, 0x40, 0xb8, 0x1e, 0x85, 0xeb,
0x51, 0xb8, 0x5e, 0x40, 0x20, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x40, 0x02, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x9a, 0x99, 0x99, 0x99, 0x99, 0x99, 0x19, 0x40,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xb9, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x0a, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x9a, 0x99, 0x99, 0x99, 0x99, 0x99, 0x19, 0x40, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0xb9, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x24, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x69, 0x1d, 0x55, 0x4d, 0x10, 0x75, 0x0f, 0x40, 0xb8, 0x1e, 0x85, 0xeb, 0x51, 0xb8, 0x6e, 0x40,
0xb8, 0x1e, 0x85, 0xeb, 0x51, 0xb8, 0x5e, 0x40, 0x30, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x40,
0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x04, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x9f, 0x40, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x40, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40,
0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x9f, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x0a, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x14, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x00,
0x00, 0x40, 0x9f, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x0a, 0x00, 0x00, 0x00,
0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x14, 0x40, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x03, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00
};
int zcu208_rfdcInit(void)
{
    struct metal_init_params init_param = METAL_INIT_DEFAULTS;
    XRFdc_Config *ConfigPtr = &Config;
    XRFdc *RFdcInstPtr = &RFdcInst;
    int status;

    if ( metal_init( &init_param ) )
    {
        printf("ERR: metal_init ... failed\n");
        //return -1;
    }

    metal_set_log_level( METAL_LOG_WARNING );

    /* Initialize the RFdc driver. */
    
    // ConfigPtr = XRFdc_LookupConfig( RFDC_DEVICE_ID );
    // if (ConfigPtr == NULL)
    // {
    //     printf("ERR: XRFdc_LookupConfig ... failed\n");
    //     //return -1;
    // }

    memcpy(ConfigPtr,rfdc_init_pra,sizeof(rfdc_init_pra));
    printf("Config -> IPType is %d\n",ConfigPtr->IPType);
    printf("Config -> SiRevision is %d\n",ConfigPtr->SiRevision);
    printf("Config -> baseaddr is 0x%08lx\n",ConfigPtr->BaseAddr);
    status = XRFdc_RegisterMetal(RFdcInstPtr, RFDC_DEVICE_ID, &g_device);
    if (status != XRFDC_SUCCESS) 
    {
        printf("ERR: XRFdc_RegisterMetal ... failed\n");
       //return -1;
    }

    /* Initializes the controller */
    status = XRFdc_CfgInitialize(RFdcInstPtr, ConfigPtr);
    if (status != XRFDC_SUCCESS)
    {
        printf("ERR: XRFdc_CfgInitialize ... failed\n");
        //return -1;
    }
    return 0;
}

void zcu208_rfdcUninit(void)
{
    metal_finish();
}
void rfdc_getSampleFrequency( XRFdc *RFdcInstPtr )
{
	XRFdc_Distribution_Settings DistributionSettings;
	// double sampleRate;
    int i;

	memset(&DistributionSettings, 0, sizeof(DistributionSettings));
	if( XRFDC_SUCCESS != XRFdc_GetClkDistribution(RFdcInstPtr, &DistributionSettings) )
    {
        printf("rfdc: error in XRFdc_GetClkDistribution()\n");
        return;
    }

    for( i=0; i<XRFDC_TILE_ID4; i++ )
    {
        RFdcInstPtr->DAC_Tile[i].PLL_Settings.SampleRate = 
                DistributionSettings.DAC[i].PLLSettings.SampleRate;
        //printf( "rfdc: DAC tile %d \n", i );
        //printf( "      sampling frequency %lf MHz\n", XRFDC_MILLI*RFdcInstPtr->DAC_Tile[i].PLL_Settings.SampleRate );
    }

    for( i=0; i<XRFDC_TILE_ID4; i++ )
    {
        RFdcInstPtr->ADC_Tile[i].PLL_Settings.SampleRate = 
                DistributionSettings.ADC[i].PLLSettings.SampleRate;
        //printf( "rfdc: ADC tile %d \n", i );
        //printf( "      sampling frequency %lf MHz\n", XRFDC_MILLI*RFdcInstPtr->ADC_Tile[i].PLL_Settings.SampleRate );
    }

    return;
}

/**
 * RFDC set frequency and the Nyquist zone to be used in ADC block.
 * 
 * @param [in]  tile  Valid values are 0-3.
 * @param [in]	blk  ADC block number inside the tile. Valid values	are 0-3.
 * @param [in]  frequency  The frequency for mixer (MHz).
 *
 * @return
 *
 */
int rfdc_setADCCenterFreq(int tile, int blk, double frequency)
{
    XRFdc *RFdcInstPtr = &RFdcInst;
	XRFdc_Mixer_Settings getMixerSettings = {0};
	XRFdc_BlockStatus getBlockStatus = {0};
	u32 getNyquistZone;
    double sampleFreq;
    int i, j;

    i=tile;
    j=blk;
    //for( i=0; i<XRFDC_NUM_OF_TILES4; i++ )
    {
        //if( !((tile>>i)&1) )
        //    continue;
        rfdc_getSampleFrequency( RFdcInstPtr );

        if( XRFDC_SUCCESS != XRFdc_CheckTileEnabled(RFdcInstPtr,XRFDC_ADC_TILE,i) )
        {
            printf( "rfdc: ADC tile %d not enabled\n", i );
            //continue;
            return -1;
        }

        //for( j=0; j<XRFDC_NUM_OF_BLKS4; j++ )
        {
            if( !(XRFdc_IsADCBlockEnabled(RFdcInstPtr,i,j)) )
            {
                printf( "rfdc: ADC tile %d block %d not enabled\n", i, j );
                //continue;
                return -1;
            }
            if( XRFDC_SUCCESS != XRFdc_GetBlockStatus(RFdcInstPtr, XRFDC_ADC_TILE, i, j, &getBlockStatus) )
            {
                printf( "rfdc: error get status of ADC tile %d block %d\n", i, j );
                //continue;
                return -1;
            }
            if( XRFDC_SUCCESS != XRFdc_GetMixerSettings(RFdcInstPtr, XRFDC_ADC_TILE, i, j, &getMixerSettings) )
            {
                printf( "rfdc: error get mixer cfg of ADC tile %d block %d\n", i, j );
                //continue;
                return -1;
            }
            if( XRFDC_SUCCESS != XRFdc_GetNyquistZone(RFdcInstPtr, XRFDC_ADC_TILE, i, j, &getNyquistZone))
            {
                printf( "rfdc: error get n zone of ADC tile %d block %d\n", i, j );
                //continue;
                return -1;
            }
            
            printf( "rfdc: ADC tile %d block %d\n", i, j );
            //printf( "      block sampling rate %lf\n", getBlockStatus.SamplingFreq );
            //printf( "      current N zone %d\n", getNyquistZone );
            //printf( "      current mixer freq %lf\n\n", getMixerSettings.Freq );
            printf( "      Frequency %lf\n\n", frequency );

            sampleFreq = getBlockStatus.SamplingFreq * XRFDC_MILLI;
#if 0
            do {
                if (frequency < -(sampleFreq)) {
                    frequency +=  sampleFreq;
                }
                if (frequency > (sampleFreq)) {
                    frequency -= sampleFreq;
                }
            } while ( (frequency < -(sampleFreq)) || (frequency > (sampleFreq)) );
            getNyquistZone = (frequency > sampleFreq/2)?
                                XRFDC_EVEN_NYQUIST_ZONE: XRFDC_ODD_NYQUIST_ZONE;
            getMixerSettings.Freq = (getNyquistZone==XRFDC_EVEN_NYQUIST_ZONE)? 
                                    frequency: -frequency;
#else
            if (frequency >= (sampleFreq / 2))
            {
                getMixerSettings.Freq = sampleFreq - frequency;
                getNyquistZone = 2;
            }
            else
            {
                getMixerSettings.Freq = -frequency;
                getNyquistZone = 1;
            }
#endif
            //printf( "      new N zone %d\n", getNyquistZone );
            //printf( "      new mixer freq %lf\n\n", getMixerSettings.Freq );

            getMixerSettings.EventSource = XRFDC_EVNT_SRC_TILE;

            if( XRFDC_SUCCESS != XRFdc_SetNyquistZone(RFdcInstPtr, XRFDC_ADC_TILE, i, j, getNyquistZone))
            {
                printf( "rfdc: error set n zone of ADC tile %d block %d to zone %d\n", i, j, getNyquistZone );
                return -1;
            }
            if( XRFDC_SUCCESS != XRFdc_SetMixerSettings(RFdcInstPtr, XRFDC_ADC_TILE, i, j, &getMixerSettings) )
            {
                printf( "rfdc: error set mixer cfg of ADC tile %d block %d\n", i, j );
                return -1;
            }
            if( XRFDC_SUCCESS != XRFdc_UpdateEvent(RFdcInstPtr, XRFDC_ADC_TILE, i, j, XRFDC_EVENT_MIXER) )
            {
                printf( "rfdc: error update mixer event of ADC tile %d block %d\n", i, j );
                return -1;
            }
        }
    }

    return 0;
}
int zcu208_setAdcDSA(int tile, int block, unsigned int rts, float atten)
{
    XRFdc *RFdcInstPtr = &RFdcInst;
    XRFdc_DSA_Settings settings;

    settings.DisableRTS = rts;
    settings.Attenuation = atten;

    if (XRFdc_SetDSA(RFdcInstPtr, tile, block, &settings)
        != XRFDC_SUCCESS)
    {
        printf("rfdc: error in XRFdc_SetDSA()\n");
        //return -1;
    }

    return 0;
}

float zcu208_getAdcDSA(int tile, int block, unsigned int rts)
{
    XRFdc *RFdcInstPtr = &RFdcInst;
    XRFdc_DSA_Settings settings;

    if (XRFdc_GetDSA(RFdcInstPtr, tile, block, &settings)
        != XRFDC_SUCCESS)
    {
        printf("rfdc: error in XRFdc_SetDSA()\n");
        //return -1;
    }

    return settings.Attenuation;
}

int main(int argc, char *argv[])
{
    int atten = 10;
    printf("12345test\n");
    if (zcu208_rfdcInit() < 0)
    {
        printf("ERR: zcu208_rfdcInit\n");
        //return -1;
    }
    printf("SiRevision =%d\n",(&RFdcInst)->RFdc_Config.SiRevision);
    #define IOTEST 0
    #if IOTEST
    printf("xrfdc_read dsa reg [0x%08x] \n",XRFdc_ReadReg(NULL, 0x14000, 0x244));
    #else
    if(argc==1)
    {
        printf("get adc atten =%f\n",zcu208_getAdcDSA(0, 0, 0));
    }
    else
    {
        if(argv[1])
            atten=atoi(argv[1]);
        printf("set adc atten =%d\n",atten);
        zcu208_setAdcDSA(0, 0, 0, (float)atten);
        printf("set  ADCCenterFreq =%d\n",atten*100);
        rfdc_setADCCenterFreq(0,0,(double)(1*atten*100));
    }
    #endif
    zcu208_rfdcUninit();
    printf("rfdc: hoho down\n");
    return 0;
}

